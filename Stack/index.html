<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Summoner Insights Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #0f172a;
            color: white;
        }

        input,
        button {
            padding: 8px;
            font-size: 14px;
        }

        input {
            width: 250px;
            margin-right: 10px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 260px 1fr 260px;
            /* LEFT - CENTER - RIGHT */
            gap: 2vw;
            margin-top: 20px;
            align-items: start;
        }

        #rankInfo {
            background: #1e293b;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #334155;
        }

        .match-card {
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #1e293b;
            border: 2px solid #334155;
            width: 100%;
            max-width: 850px;
            box-sizing: border-box;
            cursor: pointer;
        }

        .match-card.win {
            border-left: 8px solid #3b82f6;
        }

        .match-card.loss {
            border-left: 8px solid #ef4444;
        }

        .items img {
            width: 28px;
            height: 28px;
            margin-right: 4px;
            vertical-align: middle;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
        }

        .match-details {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #475569;
            display: none;
        }

        .match-details.visible {
            display: block;
        }

        .player-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .player-table th,
        .player-table td {
            padding: 6px;
            text-align: center;
            border-bottom: 1px solid #334155;
        }

        .player-table td img,
        .player-table td .empty-slot {
            width: 28px;
            height: 28px;
            vertical-align: middle;
            margin-right: 4px;
        }


        .bar {
            height: 8px;
            background: #3b82f6;
            display: inline-block;
        }

        .team-header {
            text-align: left;
            padding: 8px;
            font-weight: bold;
        }

        .team-defeat {
            background-color: rgba(239, 68, 68, 0.2);
        }

        .team-victory {
            background-color: rgba(59, 130, 246, 0.2);
        }

        .empty-slot {
            width: 28px;
            height: 28px;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid #334155;
            border-radius: 4px;
            display: inline-block;
            margin-right: 4px;
        }
    </style>
</head>

<body>
    <h1>Summoner Insights Dashboard</h1>
    <select id="gameModeSelect">
        <option value="">All Modes</option>
        <option value="CLASSIC">Normal</option>
        <option value="ARAM">ARAM</option>
        <option value="CHERRY">Arena</option>
    </select>

    <input type="number" id="gameCount" placeholder="Number of Games" min="1" max="50" value="10">

    <input id="riotId" placeholder="Enter Riot ID (e.g. lolarmon1#NA1)">
    <button onclick="fetchMatchStats()">Search</button>

    <div class="dashboard">
        <!-- Column 1: Ranked Info -->
        <div id="rankInfo">
            <h3>Ranked Info</h3>
            <p>Coming soon...</p>
        </div>

        <!-- Column 2: Match Cards -->
        <div id="matchContainer" style="display: flex; flex-direction: column; align-items: flex-start;"></div>

        <!-- Column 3: Infographic Panel -->
        <div id="infographicPanel"
            style="background:#1e293b; padding:12px; border-radius:8px; border:1px solid #334155;">
            <h3>Total Stats</h3>
            <p id="stat-winrate">Winrate: -</p>
            <p id="stat-kda">Total K/D/A: -</p>
            <p id="stat-kdaratio">KDA Ratio: -</p>
            <p id="stat-damage">Total Damage Dealt: -</p>
            <p id="stat-taken">Total Damage Taken: -</p>
            <p id="stat-mitigated">Self-Mitigated Damage: -</p>
            <p id="stat-healing">Total Healing Done: -</p>
        </div>
    </div>

    <script>
        function toggleDetails(card) {
            const detail = card.querySelector('.match-details');
            detail.classList.toggle('visible');
        }
        function getChampImgName(name) {
            const overrides = {
                FiddleSticks: 'Fiddlesticks',
                Wukong: 'MonkeyKing',
                NunuWillump: 'Nunu',
                Renata: 'RenataGlasc',
                Belveth: 'Belveth',
                Kaisa: 'Kaisa',
                Kogmaw: 'KogMaw',
                AurelionSol: 'AurelionSol',
            };
            return overrides[name] || name;
        }


        async function fetchMatchStats() {
            const input = document.getElementById('riotId').value;
            const [gameName, tagLine] = input.split('#');
            if (!gameName || !tagLine) return alert('Invalid Riot ID');

            const res1 = await fetch(`http://localhost:3000/api/summoner/${gameName}/${tagLine}`);
            const summoner = await res1.json();
            const puuid = summoner.puuid;

            // ✅ Get filters from the user
            const mode = document.getElementById('gameModeSelect').value;
            const count = document.getElementById('gameCount').value || 10;

            // ✅ Request filtered matches from backend
            const res2 = await fetch(`http://localhost:3000/api/matches/${puuid}?count=${count}&mode=${mode}`);
            const matches = await res2.json();

            const container = document.getElementById('matchContainer');
            container.innerHTML = '';

            let totalDealt = 0;
            let totalTaken = 0;
            let totalMitigated = 0;
            let totalHealing = 0;
            let wins = 0;
            let totalKills = 0;
            let totalDeaths = 0;
            let totalAssists = 0;



            for (const match of matches) {
                const player = match.info.participants.find(p => p.puuid === puuid);
                const redTeam = match.info.participants.filter(p => p.teamId === 200);
                const blueTeam = match.info.participants.filter(p => p.teamId === 100);

                if (player.win) wins++;
                totalKills += player.kills;
                totalDeaths += player.deaths;
                totalAssists += player.assists;

                const redWin = redTeam[0].win;
                const blueWin = blueTeam[0].win;

                let victoryTeam, defeatTeam;
                let victoryLabel, defeatLabel;

                if (redWin) {
                    victoryTeam = redTeam;
                    defeatTeam = blueTeam;
                    victoryLabel = "Victory (Red Team)";
                    defeatLabel = "Defeat (Blue Team)";
                } else {
                    victoryTeam = blueTeam;
                    defeatTeam = redTeam;
                    victoryLabel = "Victory (Blue Team)";
                    defeatLabel = "Defeat (Red Team)";
                }

                totalDealt += player.totalDamageDealtToChampions || 0;
                totalTaken += player.totalDamageTaken || 0;
                totalMitigated += player.damageSelfMitigated || 0;
                totalHealing += player.totalHeal || 0;

                const win = player.win;
                const kdaRatio = player.deaths === 0 ? (player.kills + player.assists).toFixed(2) : ((player.kills + player.assists) / player.deaths).toFixed(2);
                const kda = `${player.kills} / ${player.deaths} / ${player.assists} (${kdaRatio})`;
                const cs = player.totalMinionsKilled;
                const csPerMin = (cs / (match.info.gameDuration / 60)).toFixed(1);
                const wards = player.wardsPlaced;
                const showVision = match.info.gameMode.toUpperCase() === 'CLASSIC';
                let champ = player.championName;

                // Normalize the name for image URL
                const overrides = {
                    FiddleSticks: 'Fiddlesticks',
                    Wukong: 'MonkeyKing',
                    NunuWillump: 'Nunu',
                    Renata: 'RenataGlasc',
                    Belveth: 'Belveth',
                    Kaisa: 'Kaisa',
                    Kogmaw: 'KogMaw',
                    AurelionSol: 'AurelionSol',
                };
                const champImgName = overrides[champ] || champ;
                const duration = `${Math.floor(match.info.gameDuration / 60)}:${String(match.info.gameDuration % 60).padStart(2, '0')}`;
                const items = [player.item0, player.item1, player.item2, player.item3, player.item4, player.item5, player.item6];
                const itemImgs = items.map(id => id
                    ? `<img src="https://ddragon.leagueoflegends.com/cdn/15.10.1/img/item/${id}.png" alt="Item">`
                    : `<div class="empty-slot"></div>`
                ).join('');
                const maxDamage = Math.max(...match.info.participants.map(p => p.totalDamageDealtToChampions));


                const card = document.createElement('div');
                card.className = `match-card ${win ? 'win' : 'loss'}`;
                card.onclick = () => toggleDetails(card);
                card.innerHTML = `
          <div class="summary-row">
            <div><strong>${match.info.gameMode}</strong></div>
            <div>${duration}</div>
          </div>
          <div class="summary-row" style="align-items: center;">
            <div style="display: flex; align-items: center;">
              <img src="https://ddragon.leagueoflegends.com/cdn/15.10.1/img/champion/${champImgName}.png" alt="${champ}" style="width: 32px; height: 32px; margin-right: 8px; border-radius: 4px;">
              <span>${champ}</span>
            </div>
            <div><strong>${win ? 'Win' : 'Loss'}</strong></div>
          </div>
          <div class="summary-row">
            <div><strong>KDA:</strong> ${kda}</div>
            <div><strong>CS:</strong> ${cs} (${csPerMin})</div>
            <div style="visibility: ${showVision ? 'visible' : 'hidden'};"><strong>Wards:</strong> ${wards}</div>
          </div>
          <div class="summary-row" style="gap: 4px; flex-wrap: wrap; align-items: center;">
  <div class="items" style="display: flex; flex-wrap: wrap; gap: 4px;">
    ${itemImgs}
  </div>
</div>

          <div class="match-details">
            
            <div class="team-header team-victory">Victory (Red Team)</div>
            <table class="player-table team-victory">
              <tbody>
                ${victoryTeam.map(p => `
                <tr>
                  <td><img src="https://ddragon.leagueoflegends.com/cdn/15.10.1/img/champion/${getChampImgName(p.championName)}.png"> ${p.summonerName}</td>
                  <td>${p.kills}/${p.deaths}/${p.assists} (${(p.deaths === 0 ? (p.kills + p.assists) : ((p.kills + p.assists) / p.deaths)).toFixed(2)})</td>
                  <td>
                    ${p.totalDamageDealtToChampions}<br>
                    <span class="bar" style="width:${(p.totalDamageDealtToChampions / maxDamage) * 100}%"></span>
                  </td>
                  <td>${p.goldEarned} (${(p.goldEarned / (match.info.gameDuration / 60)).toFixed(1)})</td>
                  <td>${p.totalMinionsKilled} (${(p.totalMinionsKilled / (match.info.gameDuration / 60)).toFixed(1)})</td>
                  <td>${p.wardsPlaced}</td>
                  <td>${[p.item0, p.item1, p.item2, p.item3, p.item4, p.item5, p.item6]
                        .map(id => id
                            ? `<img src="https://ddragon.leagueoflegends.com/cdn/15.10.1/img/item/${id}.png">`
                            : `<div class="empty-slot"></div>`
                        ).join('')}</td>

                </tr>`).join('')}
              </tbody>
            </table>
            <div class="team-header team-defeat">Defeat (Blue Team)</div>
            <table class="player-table team-defeat">
              <thead>
                <tr><th>Player</th><th>KDA</th><th>Damage</th><th>Gold</th><th>CS</th><th>Wards</th><th>Items</th></tr>
              </thead>
              <tbody>
                ${defeatTeam.map(p => `
                <tr>
                  <td><img src="https://ddragon.leagueoflegends.com/cdn/15.10.1/img/champion/${getChampImgName(p.championName)}.png"> ${p.summonerName}</td>
                  <td>${p.kills}/${p.deaths}/${p.assists} (${(p.deaths === 0 ? (p.kills + p.assists) : ((p.kills + p.assists) / p.deaths)).toFixed(2)})</td>
                  <td>
                    ${p.totalDamageDealtToChampions}<br>
                    <span class="bar" style="width:${(p.totalDamageDealtToChampions / maxDamage) * 100}%"></span>
                  </td>
                  <td>${p.goldEarned} (${(p.goldEarned / (match.info.gameDuration / 60)).toFixed(1)})</td>
                  <td>${p.totalMinionsKilled} (${(p.totalMinionsKilled / (match.info.gameDuration / 60)).toFixed(1)})</td>
                  <td>${p.wardsPlaced}</td>
                    <td>${[p.item0, p.item1, p.item2, p.item3, p.item4, p.item5, p.item6]
                                .map(id => id
                                    ? `<img src="https://ddragon.leagueoflegends.com/cdn/15.10.1/img/item/${id}.png">`
                                    : `<div class="empty-slot"></div>`
                                ).join('')}</td>
                </tr>`).join('')}
              </tbody>
            </table>
          </div>`;

                container.appendChild(card);
            }
            const winRate = ((wins / matches.length) * 100).toFixed(1);
            const kdaRatioTotal = totalDeaths === 0 ? '∞' : ((totalKills + totalAssists) / totalDeaths).toFixed(2);
            const totalKDA = `${totalKills}/${totalDeaths}/${totalAssists}`;

            document.getElementById('stat-damage').textContent = `Total Damage Dealt: ${totalDealt.toLocaleString()}`;
            document.getElementById('stat-taken').textContent = `Total Damage Taken: ${totalTaken.toLocaleString()}`;
            document.getElementById('stat-mitigated').textContent = `Self-Mitigated Damage: ${totalMitigated.toLocaleString()}`;
            document.getElementById('stat-healing').textContent = `Total Healing Done: ${totalHealing.toLocaleString()}`;
            document.getElementById('stat-winrate').textContent = `Winrate: ${winRate}%`;
            document.getElementById('stat-kda').textContent = `Total K/D/A: ${totalKDA}`;
            document.getElementById('stat-kdaratio').textContent = `KDA Ratio: ${kdaRatioTotal}`;
        }

    </script>
</body>

</html>
